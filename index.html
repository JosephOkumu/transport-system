<!DOCTYPE html>
<html>
<head>
    <title>Bus Simulation with Routing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <style>
        #map {
            height: 500px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([-1.286389, 36.817223], 13);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Define the waypoints for the route
        const waypoints = [
            L.latLng(-1.286389, 36.817223),   // Start point (Nairobi CBD)
            L.latLng(-1.292066, 36.821945),   // Uhuru Park
            L.latLng(-1.301428, 36.776025),   // Wilson Airport
            L.latLng(-1.320152, 36.802490),   // Langata
            L.latLng(-1.328449, 36.856213)    // End point (Karen)
        ];

        // Create a routing control
        const routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            show: false,
            addWaypoints: false,
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            })
        }).addTo(map);

        // Create a bus marker
        const busMarker = L.marker(waypoints[0]).addTo(map);

        // Function to simulate bus movement along the route
        function moveBus() {
            // Wait for routing to complete
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                if (routes.length > 0) {
                    const route = routes[0];
                    const coordinates = route.coordinates;
                    
                    let currentIndex = 0;
                    const steps = coordinates.length;

                    function animateBus() {
                        if (currentIndex < steps) {
                            const currentCoord = coordinates[currentIndex];
                            busMarker.setLatLng([currentCoord.lat, currentCoord.lng]);
                            currentIndex++;

                            // Adjust speed of animation (lower number = slower)
                            setTimeout(animateBus, 50);
                        } else {
                            // Loop back to start
                            currentIndex = 0;
                            animateBus();
                        }
                    }

                    // Start bus animation
                    animateBus();
                }
            });
        }

        // Start the simulation when routing is ready
        moveBus();
    </script>
</body>
</html>